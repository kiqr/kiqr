#!/usr/bin/env ruby

require "bundler/setup"

require "fileutils"
require "open3"
require "kiqr"

def run_command(command)
  puts "Running: #{command}"
  output, status = Open3.capture2e(command)
  puts output
  exit(1) unless status.success?
end


# Clean up and recreate the temporary directory
repo_path = "/tmp/kiqr-starter"
FileUtils.rm_rf(repo_path) if Dir.exist?(repo_path)
FileUtils.mkdir_p(repo_path)

# Clone the starter repository
run_command("git clone git@github.com:kiqr/starter.git #{repo_path}")


# Run kiqr CLI to generate a new starter template
Dir.chdir(repo_path) do
  run_command("bin/kiqr update")
  run_command("bin/rails db:migrate")
end

# Commit and push the changes
Dir.chdir(repo_path) do
  run_command('git add .')
  run_command("git commit -m 'Update starter template to version #{Kiqr::VERSION}'")
  run_command('git push origin main')
end

puts "Starter template updated and pushed successfully!"
